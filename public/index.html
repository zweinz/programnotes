<!DOCTYPE html>
<!-- This code is nasty. I'm sorry, I'm in music school now. Very much a prototype. -->

<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Program Notes</title>

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/7.6.1/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/7.6.1/firebase-auth.js"></script>
    <script defer src="/__/firebase/7.6.1/firebase-database.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-162772805-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-162772805-1');
    </script>



    <style media="screen">
      body { background: black; color: white; font-family: -apple-system, Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
      a {color: white; text-decoration: underline;}
      #message { background: #121212; max-width: 360px; margin: 100px auto 16px; padding: 32px 24px; border-radius: 3px; }
      #message h2 { color: #BB86FC; font-weight: bold; font-size: 16px; margin: 0 0 8px; }
      #message h1 { font-size: 22px; font-weight: 300; color: rgba(0,0,0,0.6); margin: 0 0 16px;}
      #message p { line-height: 140%; margin: 16px 0 24px; font-size: 14px; }
      #message a.cta { display: block; text-align: center; background: #039be5; text-transform: uppercase; text-decoration: none; color: white; padding: 16px; border-radius: 4px; }
      #message, #message a { box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); }
      #controlButtons { display: none; }
      #currentProgram > div {display: none;} 
      label {display: block;  padding: 8px 0;} 
      button { height: 44px; min-width: 44px; margin: 36px 8px 0; padding: 8px; background-color: #BB86FC}
      @media (max-width: 600px) {
        body, #message { margin-top: 0; background: #121212; box-shadow: none; }
        body { border-top: 16px solid #BB86FC; }
      }
      @-ms-viewport{ width: device-width; }

      input[type=checkbox] {
        width: 1em;
        height: 1em;
        background-color: white;
        border-radius: 33%;
        vertical-align: middle;
        border: 1px 4px solid #ddd;
        -webkit-appearance: none;
        outline: none;
        cursor: pointer;
        margin: 2px 4px;
      }
      input[type=checkbox]:checked {
        background-color: #3700B3;
      }

      #message ul {list-style-type: none; padding: 0;}
      #message ul li {padding: 4px; border-radius: 4px}
      #message ul li p {margin: 4px 0;}
      .highlighted {background-color: #BB86FC; color: #121212; margin: 4px 0;}
      .section {margin-top: 8px;}

      #message .note > p {border-bottom: 1px solid gray; padding-bottom: 16px; margin: 16px 0;}
      #message #note0 > p {border: 0; padding-bottom: 8px; margin: 8px;}
    </style>
  </head>
  <body>
    <div id="message">
      <!--h2>Zach Weiner, piano</h2-->
      <div id="currentProgram">
        <div id="controlButtons">
          <button id="prevButton">Previous</button>
          <button id="nextButton">Next</button>
          <button id="resetButton">Reset</button>
        </div>

        <h3 id="movementNum"></h3>
        
        <div id="note0" class="note">
          <p>
            These program notes are meant to give people new to this piece a "way in" to Bach's Goldberg Variations. I will be playing the second half, variations 16-30.
          </p>
        </div>

        <div id="note1" class="note">
          <h4>Aria</h4>
          <p>
            This is the theme from which all the variations will unfurl. What does it mean to you?
          </p>
          <label><input type="checkbox" name="checkbox">Being at peace</label>
          <label><input type="checkbox" name="checkbox">A private dance</label>
        </div>

        <div id="note2" class="note">
          <h4>Variation 16: Overture</h4>
          <p>
            A majestic opening, followed by an energetic flurry of activity. What could this announce the beginning of?
          </p>
          <label><input type="checkbox" name="checkbox">A new family member</label>
          <label><input type="checkbox" name="checkbox">A new home</label>
        </div>

        <div id="note3" class="note">
          <h4>Variation 17</h4>
          <p>
            Good-natured and a bit quirky, this conversation between the two hands is
          </p>
          <label><input type="checkbox" name="checkbox">light banter</label>
          <label><input type="checkbox" name="checkbox">intimate flirtation</label>
        </div>

        <div id="note4" class="note">
          <h4>Variation 18</h4>
          <p>
            A stern base line combines with two higher voices talking over each other. They are
          </p>
          <label><input type="checkbox" name="checkbox">beginning an argument</label>
          <label><input type="checkbox" name="checkbox">resolving an argument</label>
        </div>

        <div id="note5" class="note">
          <h4>Variation 19</h4>
          <p>
            Put your feet up and relax with a glass of
          </p>
          <label><input type="checkbox" name="checkbox">red wine</label>
          <label><input type="checkbox" name="checkbox">white wine</label>
        </div>

        <div id="note6" class="note">
          <h4>Variation 20</h4>
          <p>
            Hand crossings galore in this display of virtuosity and one-upmanship. These are
          </p>
          <label><input type="checkbox" name="checkbox">kids on the playground</label>
          <label><input type="checkbox" name="checkbox">adults on the dance floor</label>
        </div>

        <div id="note7" class="note">
          <h4>Variation 21</h4>
          <p>
            Filled with tragic lamentations and painful dissonances, who does this make you think of you in your own life?
          </p>
        </div>

        <div id="note8" class="note">
          <h4>Variation 22</h4>
          <p>
            Spring is here and buds are sprouting in
          </p>
          <label><input type="checkbox" name="checkbox">a natural rebirth</label>
          <label><input type="checkbox" name="checkbox">a spiritual rebirth</label>
        </div>

        <div id="note9" class="note">
          <h4>Variation 23</h4>
          <p>
            The hands chase each other like
          </p>
          <label><input type="checkbox" name="checkbox">kids playing tag</label>
          <label><input type="checkbox" name="checkbox">a dog playing with a ball</label>
        </div>

        <div id="note10" class="note">
          <h4>Variation 24</h4>
          <p>
            An arrival point: if you listen closely, every theme is copied a few bars later. This dance is in the
          </p>
          <label><input type="checkbox" name="checkbox">city</label>
          <label><input type="checkbox" name="checkbox">country</label>
        </div>

        <div id="note11" class="note">
          <h4>Variation 25</h4>
          <p>
            The emotional centerpiece of the half, this darkly beautiful variation is sometimes called the Black Pearl.
            Reminiscent of Bach's "Aus Liebe", I think this variation asks, "What would you do for love?"
            What have others done for you?
          </p>
        </div>

        <div id="note12" class="note">
          <h4>Variation 26</h4>
          <p>
            Energy and excitement builds up in each hand as they cross over each other and gather steam, 
            until they play together at the climax at the end.
          </p>
        </div>

        <div id="note13" class="note">
          <h4>Variation 27</h4>
          <p>
            The two hands imitate each other exactly, in this
          </p>
          <label><input type="checkbox" name="checkbox">first dance at a society ball</label>
          <label><input type="checkbox" name="checkbox">mating ritual for two birds</label>
        </div>

        <div id="note14" class="note">
          <h4>Variation 28 + Variation 29</h4>
          <p>
            Finale part I: A babbling brook gathers steam through the 28th variation until it pours into the ocean
            in the triumphant 29th variation. 
          </p>
        </div>

        <div id="note15" class="note">
          <h4>Variation 30</h4>
          <p>
            Finale part II: Four voices come together singing folk songs as they finally arrive home
            after a long journey.
          </p>
        </div>

        <div id="note16" class="note">
          <h4>Aria</h4>
          <p>
            As we finally hear the opening theme return, we reflect on our journey to this point.
          </p>
        </div>

        <div id="note17">
          <h3>Thanks for coming!</h3>
          To keep in touch, join my mailing list <a target=_blank href="https://forms.gle/cb1MfbXawFyqWBJM7">here.</a>
        </div>

        <div id="note23">
          <h3>Welcome to this Groupmuse!</h3>
          <p>
            The first piece on the program is Bethena by Scott Joplin.
          </p>
          <p>
            I'm Zach Weiner. To keep in touch, join my mailing list <a target=_blank href="https://forms.gle/cb1MfbXawFyqWBJM7">here</a>.
          </p>
        </div>
      </div>
    </div>

    <script>


      let startingState = 0;
      class ProgramNotes {
        constructor() {
          // TODO: This is hacky, as it saves this to the database forever.
          let url = new URL(window.location.href);
          let selfControlled = url.searchParams.get("selfControlled");
          let programID = selfControlled ? "program" + Math.floor(Date.now()) : "TestProgramID";

          this.programID = programID;
          this.currentState = startingState;
          let db = firebase.database();
          this.programRef = db.ref("/programs/" + this.programID)
        }
        start() {
          this.programRef.on('value', function(snapshot) {
            let oldState = this.currentState;
            if (snapshot.exists()) {
              this.currentState = snapshot.val();
            }

            // document.getElementById("movementNum").textContent = this.currentState;
            document.getElementById("note" + oldState).style.display = "none";
            document.getElementById("note" + this.currentState).style.display = "block";
            // document.getElementById("note" + this.currentState).scrollIntoView();
          }.bind(this));
        }

        // TODO: Auth for these write functions...
        increment() {
          let index = this.currentState + 1;
          this.programRef.set(index);
          this.tellDemo(index);
        }
        decrement() {
          let index = this.currentState - 1;
          this.programRef.set(index);
          this.tellDemo(index);
        }
        reset() {
          this.programRef.set(0); 
          this.tellDemo(0);
        }

        tellDemo(index) {
          if (window.parent) {
            // TODO: security
            window.parent.postMessage(index, "*");
          }
        }
      }

      var notes;
      function setIndex(index) {
        if (index >= 0 && !!notes && index != notes.currentState) {
          notes.programRef.set(index);
        }
      }

      document.addEventListener('DOMContentLoaded', function() {
        // // 🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
        // // The Firebase SDK is initialized and available here!
        // // 🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
        notes  = new ProgramNotes();

        notes.start();

        let url = new URL(window.location.href);
        let present = url.searchParams.get("present");
        if (present) {
          document.getElementById('nextButton').onclick = function() {
            notes.increment();
          };
          document.getElementById('prevButton').onclick = function() {
            notes.decrement();
          };
          document.getElementById('resetButton').onclick = function() {
            notes.reset();
          };

          addEventListener('keyup', (event) => {
            switch (event.key) {
              case "PageUp":
              case "ArrowRight":
              case "ArrowDown":
                notes.increment();
                break;
              case "PageDown":
              case "ArrowLeft":
              case "ArrowUp":
                notes.decrement();
                break;
            }
          });

          document.getElementById('controlButtons').style.display = 'block';
        }

        try {
          let app = firebase.app();
          let features = ['auth', 'database'].filter(feature => typeof app[feature] === 'function');
          console.log(`Firebase SDK loaded with ${features.join(', ')}`);
        } catch (e) {
          console.error(e);
          console.log('Error loading the Firebase SDK, check the console.');
        }
      });
    </script>
  </body>
</html>
